import json
import re
import pandas as pd
import folium
from folium.plugins import MarkerCluster, FeatureGroupSubGroup
from branca.element import Element

def prepara_df_libri(df):
    """Crea colonne separate per rep e luogo."""
    if "Coordinate_Decimali_rep" in df.columns:
        df[["Lat_rep", "Lon_rep"]] = df["Coordinate_Decimali_rep"].str.split(",", expand=True)
        df["Lat_rep"] = pd.to_numeric(df["Lat_rep"].str.strip(), errors="coerce")
        df["Lon_rep"] = pd.to_numeric(df["Lon_rep"].str.strip(), errors="coerce")

    if "Coordinate_Decimali_luogo" in df.columns:
        df[["Lat_luogo", "Lon_luogo"]] = df["Coordinate_Decimali_luogo"].str.split(",", expand=True)
        df["Lat_luogo"] = pd.to_numeric(df["Lat_luogo"].str.strip(), errors="coerce")
        df["Lon_luogo"] = pd.to_numeric(df["Lon_luogo"].str.strip(), errors="coerce")
    return df
# ---------- FUNZIONI DI SUPPORTO ----------
def prepara_df(df):
    if "Coordinate_Decimali" not in df.columns:
        raise ValueError("Manca la colonna 'Coordinate_Decimali'")
    df[["Lat", "Lon"]] = df["Coordinate_Decimali"].str.split(",", expand=True)
    df["Lat"] = pd.to_numeric(df["Lat"].str.strip(), errors="coerce")
    df["Lon"] = pd.to_numeric(df["Lon"].str.strip(), errors="coerce")
    return df.dropna(subset=["Lat", "Lon"]).reset_index(drop=True)

def is_visited(val):
    if pd.isna(val):
        return False
    if isinstance(val, (int, float)):
        return int(val) == 1
    s = str(val).strip().lower()
    return s in {"s", "si", "s√¨", "yes", "y", "true", "1", "visitato", "v"}

# ---------- CARICAMENTO FILE ----------
df = prepara_df(pd.read_excel("FoglioConCoor_Convertito.xlsx"))
df1 = prepara_df(pd.read_excel("LuoghiConCoor_Convertito.xlsx"))
df_libri = prepara_df_libri(pd.read_excel("libri.xlsx"))
df_links = pd.read_excel("foglio_links.xlsx")

id_map = dict(zip(df_links["ID Ivanov"], df_links["ID"]))

# ---------- CREA MAPPA ----------
mappa = folium.Map(location=[45.0, 11.5], zoom_start=2, control_scale=True, id = "map")
fontawesome_link = Element("""
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
""")
mappa.get_root().html.add_child(fontawesome_link)

# ---------- CLUSTER PRINCIPALE ----------
main_cluster = MarkerCluster(control=False).add_to(mappa)

# ---------- SOTTOGRUPPI PER CHECKBOX ----------
# --- Definizione dei sottogruppi ---
persona_rossa_layer = FeatureGroupSubGroup(
    main_cluster,
    """Contatti diretti 
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="vertical-align:middle;">
        <path fill="#f41e06" d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"/>
    </svg>"""
)

persona_blu_layer = FeatureGroupSubGroup(
    main_cluster,
    """Contatti indiretti 
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="vertical-align:middle;">
        <path fill="#74C0FC" d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"/>
    </svg>"""
)

luogo_rosso_layer = FeatureGroupSubGroup(
    main_cluster,
    """Luoghi visitati e/o frequentati 
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16">
        <path fill="#f90b0b" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM288 224C288 206.3 302.3 192 320 192C337.7 192 352 206.3 352 224C352 241.7 337.7 256 320 256C302.3 256 288 241.7 288 224zM280 288L328 288C341.3 288 352 298.7 352 312L352 400L360 400C373.3 400 384 410.7 384 424C384 437.3 373.3 448 360 448L280 448C266.7 448 256 437.3 256 424C256 410.7 266.7 400 280 400L304 400L304 336L280 336C266.7 336 256 325.3 256 312C256 298.7 266.7 288 280 288z"/>
    </svg>"""
)

luogo_blu_layer = FeatureGroupSubGroup(
    main_cluster,
    """Luoghi altrimenti noti 
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16">
        <path fill="#74C0FC" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM288 224C288 206.3 302.3 192 320 192C337.7 192 352 206.3 352 224C352 241.7 337.7 256 320 256C302.3 256 288 241.7 288 224zM280 288L328 288C341.3 288 352 298.7 352 312L352 400L360 400C373.3 400 384 410.7 384 424C384 437.3 373.3 448 360 448L280 448C266.7 448 256 437.3 256 424C256 410.7 266.7 400 280 400L304 400L304 336L280 336C266.7 336 256 325.3 256 312C256 298.7 266.7 288 280 288z"/>
    </svg>"""
)

libro_rosso_layer = FeatureGroupSubGroup(
    main_cluster,
    """Manoscritto, luogo di copiatura 
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="vertical-align:middle;">
        <path fill="#f20707" d="M480 576L192 576C139 576 96 533 96 480L96 160C96 107 139 64 192 64L496 64C522.5 64 544 85.5 544 112L544 400C544 420.9 530.6 438.7 512 445.3L512 512C529.7 512 544 526.3 544 544C544 561.7 529.7 576 512 576L480 576zM192 448C174.3 448 160 462.3 160 480C160 497.7 174.3 512 192 512L448 512L448 448L192 448zM224 216C224 229.3 234.7 240 248 240L424 240C437.3 240 448 229.3 448 216C448 202.7 437.3 192 424 192L248 192C234.7 192 224 202.7 224 216zM248 288C234.7 288 224 298.7 224 312C224 325.3 234.7 336 248 336L424 336C437.3 336 448 325.3 448 312C448 298.7 437.3 288 424 288L248 288z"/>
    </svg>"""
)

libro_blu_layer = FeatureGroupSubGroup(
    main_cluster,
    """Manoscritto, luogo di conservazione (luogo di copiatura ignoto)
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="vertical-align:middle;">
        <path fill="#74C0FC" d="M480 576L192 576C139 576 96 533 96 480L96 160C96 107 139 64 192 64L496 64C522.5 64 544 85.5 544 112L544 400C544 420.9 530.6 438.7 512 445.3L512 512C529.7 512 544 526.3 544 544C544 561.7 529.7 576 512 576L480 576zM192 448C174.3 448 160 462.3 160 480C160 497.7 174.3 512 192 512L448 512L448 448L192 448zM224 216C224 229.3 234.7 240 248 240L424 240C437.3 240 448 229.3 448 216C448 202.7 437.3 192 424 192L248 192C234.7 192 224 202.7 224 216zM248 288C234.7 288 224 298.7 224 312C224 325.3 234.7 336 248 336L424 336C437.3 336 448 325.3 448 312C448 298.7 437.3 288 424 288L248 288z"/>
    </svg>"""
)

extra_layer = FeatureGroupSubGroup(
    main_cluster,
    '''Tappe successive al periodo italiano 
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16">
      <path fill="#4b4e53" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM288 224C288 206.3 302.3 192 320 192C337.7 192 352 206.3 352 224C352 241.7 337.7 256 320 256C302.3 256 288 241.7 288 224zM280 288L328 288C341.3 288 352 298.7 352 312L352 400L360 400C373.3 400 384 410.7 384 424C384 437.3 373.3 448 360 448L280 448C266.7 448 256 437.3 256 424C256 410.7 266.7 400 280 400L304 400L304 336L280 336C266.7 336 256 325.3 256 312C256 298.7 266.7 288 280 288z"/>
    </svg>'''
)

# --- Aggiunta di tutti i layer alla mappa ---
for layer in [
    persona_rossa_layer, persona_blu_layer,
    luogo_rosso_layer, luogo_blu_layer,
    libro_rosso_layer, libro_blu_layer,
    extra_layer
]:
    layer.add_to(mappa)

# ‚úÖ Aggiungi solo UNA volta il controllo layer (con menu chiudibile)
from folium import LayerControl

# LayerControl aperto di default
LayerControl(collapsed=False).add_to(mappa)

toggle_layercontrol_js = Element("""
<script>
document.addEventListener('DOMContentLoaded', function() {
    const control = document.querySelector('.leaflet-control-layers');
    if (!control) return;

    // --- Aggiungi la X ---
    const closeBtn = document.createElement('div');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '5px';
    closeBtn.style.right = '5px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontSize = '18px';
    closeBtn.style.fontWeight = 'bold';
    closeBtn.style.color = '#444';
    closeBtn.title = 'Chiudi pannello';
    control.appendChild(closeBtn);

    // --- Crea pulsante fisso in alto a destra (inizialmente nascosto) ---
    const openBtn = document.createElement('button');
    openBtn.innerHTML = 'Apri filtro';
    openBtn.style.position = 'fixed';
    openBtn.style.top = '10px';
    openBtn.style.right = '10px';
    openBtn.style.zIndex = '1000';
    openBtn.style.padding = '6px 12px';
    openBtn.style.background = '#fff';
    openBtn.style.border = '1px solid #ccc';
    openBtn.style.cursor = 'pointer';
    openBtn.style.display = 'none'; // inizialmente nascosto
    document.body.appendChild(openBtn);

    // --- Clic sulla X: nascondi pannello, mostra pulsante ---
    closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        control.style.visibility = 'hidden';
        openBtn.style.display = 'block';
    });

    // --- Clic sul pulsante: mostra pannello, nascondi pulsante ---
    openBtn.addEventListener('click', function() {
        control.style.visibility = 'visible';
        openBtn.style.display = 'none';
    });
});
</script>
""")

mappa.get_root().html.add_child(toggle_layercontrol_js)

def make_id(persona, luogo):
    import re

    # 1Ô∏è‚É£ prendi solo la prima parte (prima dello "/")
    persona_clean = persona.split("/")[0].strip()
    luogo_clean = luogo.split("/")[0].strip()

    # 2Ô∏è‚É£ rimuovi note tipo (cfr. ...)
    luogo_clean = re.sub(r"\(.*?\)", "", luogo_clean).strip()

    # 3Ô∏è‚É£ normalizza la persona ‚Üí es. "Marco Musuro" ‚Üí "MarcoMusuro"
    persona_id = re.sub(r"[^A-Za-z]", "", persona_clean)

    # 4Ô∏è‚É£ prime due lettere del luogo ‚Üí es. "Venezia" ‚Üí "Ve"
    luogo_id = luogo_clean[:4]

    # 5Ô∏è‚É£ ID finale
    return f"{persona_id}{luogo_id}"
# ---------- FEATUREGROUP PER ANIMAZIONE ----------
# anim_layer = folium.FeatureGroup(name="Percorso cronologico").add_to(mappa)

# ---------- FUNZIONE PER POPUP ----------
def crea_popup( luogo,pers, testi, id_map, acc_id):
    import re
    import numpy as np
    import pandas as pd

    # --- Funzione per splittare le persone con eccezioni ---
    def split_persone(pers):
        if not pers or not isinstance(pers, str) or pers.strip() == "-":
            return []
        eccezioni = [
            "Ludovico Maria Sforza, il Moro / –õ–æ–¥–æ–≤–∏–∫–æ –ú–∞—Ä–∏—è –°—Ñ–æ—Ä—Ü–∞",
            "Scipione Forteguerri, Carteromaco / –°—Ü–∏–ø–∏–æ–Ω –ö–∞—Ä—Ç–µ—Ä–æ–º–∞—Ö"
        ]
        protected = pers
        for ec in eccezioni:
            if ec in protected:
                protected = protected.replace(ec, ec.replace(", ", "‚Äπvirgola‚Ä∫"))
        parti = [p.strip() for p in re.split(r',\s*', protected) if p.strip()]
        return [p.replace("‚Äπvirgola‚Ä∫", ", ") for p in parti]

    # --- Normalizza dati ---
    persone = split_persone(pers)

    id_pers = ""

    alter=""
    # --- Stampa se la persona √® nel dizionario ---
    for p in persone:
        if p in persone_luoghi:
            print("Persona trovata nel dizionario:", p)
            print("Luoghi:", persone_luoghi[p])

            # Filtra i luoghi diversi da quello corrente
            altri_luoghi = [l for l in persone_luoghi[p] if l != luogo]

            # Costruisci HTML dei link con ID univoco per persona+luogo
            links_html = "".join(
                f'<li><a class="link" data-id="{make_id(p, l)}" href="#">{l}</a></li>'
                for l in altri_luoghi
            )
            hidden_html = f'<a class="link hidden" data-id="{make_id(p, luogo)}" href="#" style="display:none;">{luogo}</a>'
            # Combina in un div
            # --- Inietta un console.log nel popup ---


            alter = f"""
            <div style="margin-bottom:6px;">
                <b style="color:#2b5c99;">Altri luoghi:</b>
                <ul style='margin:4px 0 0 16px; padding:0;'>
                    {links_html}
                    {hidden_html}
                </ul>
                
            </div>
            """





    testi_validi = [
        t for t in (testi if isinstance(testi, (list, np.ndarray, pd.Series)) else [testi])
        if t and str(t).strip() != "-"
    ]

    print(len(testi_validi))

    # --- Sezione persone ---
    pers_html = ""
    if persone:
        pers_html = f"""
        <div style="margin-bottom:6px;">
            <b style="color:#2b5c99;">üë§ Persone:</b>
            <ul style='margin:4px 0 0 16px; padding:0;'>
                {''.join(f"<li>{p}</li>" for p in persone)}
            </ul>
        </div>
        """

    # --- Sezione testi o bibliografia ---
    occorrenze_html = ""

    if len(testi_validi) == 1:
        # ‚úÖ Caso singola occorrenza ‚Üí stampa diretta senza accordion
        testo_html = make_list(testi_validi, id_map)
        occorrenze_html = f"""
        <div>
            <b style="color:#2b5c99;">üìö Occorrenza nel corpus:</b><br>
            <ul style="margin:4px 0 0 16px; padding:0; list-style:none;">{testo_html}</ul>
        </div>
        """

    elif len(testi_validi) > 1:
        # ‚úÖ Caso multiplo ‚Üí usa accordion
        testi_html_list = make_list(testi_validi, id_map)
        occorrenze_html = f"""
        <div>
            <b style="color:#2b5c99;">üìö Occorrenze nel corpus:</b><br>
            <div class="accordion" id="accordionTesti{acc_id}">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingTesti{acc_id}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                          data-bs-target="#collapseTesti{acc_id}" style="font-size:13px; padding:2px 4px;">
                    üìö Occorrenze ({len(testi_validi)})
                  </button>
                </h2>
                <div id="collapseTesti{acc_id}" class="accordion-collapse collapse">
                  <div class="accordion-body" style="max-height:150px; overflow-y:auto; padding:0;">
                    <ul style="margin:0; padding-left:16px;">{testi_html_list}</ul>
                  </div>
                </div>
              </div>
            </div>
        </div>
        """

    elif len(testi_validi) < 1:
        # ‚úÖ Nessuna occorrenza ‚Üí estrai bibliografia dal nome del luogo
        match = re.search(r"\((.*?)\)", luogo)
        if match:
            bibl = [match.group(1).strip()]  # lista con un solo elemento
        else:
            bibl = ["-"]

        bibl_html = make_list(bibl, id_map)

        occorrenze_html = f"""
        <div>
            <b style="color:#2b5c99;">üìñ Bibliografia:</b><br>
            <ul style="margin:4px 0 0 16px; padding:0; list-style:none;">{bibl_html}</ul>
        </div>
        """

    # --- Output finale combinato ---
    popup_html = f"""
    <div style="font-size:13px; line-height:1.4;">
        
        {pers_html}
        {occorrenze_html}
        {alter}
    </div>
    """
    return popup_html

from folium import DivIcon, LayerControl

def make_list(items, id_map=None):
    """Genera la lista di link per persone o testi, ignorando valori vuoti o '-'.
    Usa label pulita per cercare l'id in id_map se presente.
    """
    def _slug(s):
        s = s.lower().strip()
        s = re.sub(r"[^\w\s-]", "", s)        # rimuove punteggiatura
        s = re.sub(r"\s+", "-", s)            # spazi -> trattini
        return s

    html = ""
    for t in items:
        if not t or str(t).strip() == "-":
            continue
        label_clean = re.sub(r"\s*\([^)]*\)\s*$", "", str(t)).strip()

        # cerca sia la chiave originale sia la label pulita in id_map
        id_num = None
        if id_map:
            if t in id_map:
                id_num = id_map[t]
            elif label_clean in id_map:
                id_num = id_map[label_clean]
        if id_num is not None:
            slug = _slug(label_clean)
            url = f"https://maximhum.muruca.cloud/work/{id_num}/{slug}"
            html += (f'<li><a href="{url}" target="_blank" '
                     f'style="display:block; text-decoration:none; color:#fff; background:#2b5c99; '
                     f'padding:2px 4px; border-radius:4px; margin-bottom:2px;">{label_clean}</a></li>')
        else:
            html += f"<li>{label_clean}</li>"
    return html

def crea_popup_luogo(luogo, persone_list, testi_list, id_map=None, acc_id=0):
    """Genera l'HTML del popup.
    - le persone sono elencate (ordinate alfabeticamente) senza link
    - i testi (occorrenze) sono ordinati in progressione numerica di Ivanov
      e usano make_list() per creare link se id_map contiene corrispondenze
    """

    # --- Normalizza luogo ---
    if isinstance(luogo, pd.Series):
        luogo = luogo.dropna().iloc[0] if not luogo.dropna().empty else None
    luogo = str(luogo).strip() if luogo and str(luogo).strip() != "" and luogo != "nan" else "‚Äî"

    # --- Filtra e normalizza liste ---
    persone_list = [str(p).strip() for p in (persone_list or []) if p and str(p).strip() != "-"]
    testi_list   = [str(t).strip() for t in (testi_list   or []) if t and str(t).strip() != "-"]

    # --- Ordina testi di Ivanov per numero ---
    def estrai_numero_ivanov(t):
        match = re.search(r"Ivanov\s*(\d+)", t)
        return int(match.group(1)) if match else float("inf")
    testi_list = sorted(testi_list, key=estrai_numero_ivanov)

    # --- Funzione split persone ---
    def split_persone(pers):
        if not pers or not isinstance(pers, str):
            return []
        eccezioni = [
            "Ludovico Maria Sforza, il Moro / –õ–æ–¥–æ–≤–∏–∫–æ –ú–∞—Ä–∏—è –°—Ñ–æ—Ä—Ü–∞",
            "Scipione Forteguerri, Carteromaco / –°—Ü–∏–ø–∏–æ–Ω –ö–∞—Ä—Ç–µ—Ä–æ–º–∞—Ö"
        ]
        protected = pers
        for ec in eccezioni:
            if ec in protected:
                protected = protected.replace(ec, ec.replace(", ", "‚Äπvirgola‚Ä∫"))
        parti = [p.strip() for p in re.split(r',\s*', protected) if p.strip()]
        return [p.replace("‚Äπvirgola‚Ä∫", ", ") for p in parti]

    # --- Espandi persone e ordina alfabeticamente ---
    persone = []
    for p in persone_list:
        p_clean = re.sub(r"[\[\]]", "", str(p))
        persone.extend(split_persone(p_clean))
    persone = [p for p in persone if p and p.strip() != "-"]
    persone = sorted(dict.fromkeys(persone), key=lambda x: x.lower())

    # --- HTML persone ---
    persone_html = ""
    if persone:  # mostra solo se ci sono persone
        pers_html = "<ul style='margin:4px 0 0 16px; padding:0;'>"
        pers_html += "".join(f"<li>{p}</li>" for p in persone)
        pers_html += "</ul>"

        if len(persone) > 4:
            persone_html = f"""
            <div style="margin-bottom:6px;">
              <b style="color:#2b5c99;">üë§ Persone:</b><br>
              <div class="accordion" id="accordionPers{acc_id}">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingPers{acc_id}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapsePers{acc_id}" style="font-size:13px; padding:2px 4px;">
                      üë§ Persone ({len(persone)})
                    </button>
                  </h2>
                  <div id="collapsePers{acc_id}" class="accordion-collapse collapse">
                    <div class="accordion-body" style="max-height:150px; overflow-y:auto; padding:0;">
                      {pers_html}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            """
        else:
            persone_html = f"""
            <div style="margin-bottom:6px;">
              <b style="color:#2b5c99;">üë§ Persone:</b><br>{pers_html}
            </div>
            """

    # --- HTML testi (occorrenze) ---
    testi_html = ""
    if testi_list:
        testi_html_list = make_list(testi_list, id_map)

        if len(testi_list) == 1:
            # una sola occorrenza ‚Üí mostra diretta senza accordion
            testi_html = f"""
            <div style="margin-bottom:6px;">
              <b style="color:#2b5c99;">üìö Occorrenza nel corpus:</b><br>
              <ul style="margin:4px 0 0 16px; padding:0; list-style:none;">{testi_html_list}</ul>
            </div>
            """
        elif len(testi_list) > 1 and len(testi_list) <= 4:
            # poche occorrenze ‚Üí mostra lista diretta
            testi_html = f"""
            <div style="margin-bottom:6px;">
              <b style="color:#2b5c99;">üìö Occorrenze nel corpus:</b><br>
              <ul style="margin:4px 0 0 16px; padding:0; list-style:none;">{testi_html_list}</ul>
            </div>
            """
        else:
            # molte occorrenze ‚Üí accordion
            testi_html = f"""
            <div style="margin-bottom:6px;">
              <div class="accordion" id="accordionTesti{acc_id}">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTesti{acc_id}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseTesti{acc_id}" style="font-size:13px; padding:2px 4px;">
                      üìö Occorrenze ({len(testi_list)})
                    </button>
                  </h2>
                  <div id="collapseTesti{acc_id}" class="accordion-collapse collapse">
                    <div class="accordion-body" style="max-height:150px; overflow-y:auto; padding:0;">
                      <ul style="margin:0; padding-left:16px;">{testi_html_list}</ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            """

    # --- HTML popup finale ---
    return f"""
    <div style="font-family: Arial; font-size:13px; line-height:1.5; color:#333; padding:8px; border-radius:10px;
                background:#fdfdfd; border:1px solid #ccc; box-shadow:0 2px 6px rgba(0,0,0,0.1); max-width:280px;">
        <div style="margin-bottom:6px;">
            <b style="color:#2b5c99;">üìç Luogo:</b><br>{luogo or '‚Äî'}
        </div>
        {testi_html}
        {persone_html}
    </div>
    """

# --- Costruzione mappa persone_luoghi ---
persone_luoghi = {}

# Prima fase: costruisco il dizionario completo
for _, row in df.iterrows():
    pers = row["pers"]
    luogo = row["Luogo"]

    if not pers or pers.strip() == "-":
        continue

    for p in [x.strip() for x in pers.split(",") if x.strip()]:
        persone_luoghi.setdefault(p, set()).add(luogo)  # uso un set per evitare duplicati

# Seconda fase: tengo solo le persone che compaiono in pi√π luoghi
persone_luoghi = {
    persona: list(luoghi)
    for persona, luoghi in persone_luoghi.items()
    if len(luoghi) > 1
}



# ---------- AGGIUNTA MARKER DF ----------
grouped_df = df.groupby([df["Lat"].round(5), df["Lon"].round(5), "pers"])
for (lat, lon,  pers), group in grouped_df:
    val = None
    if "Visitato" in group.columns and group["Visitato"].notna().any():
        val = group["Visitato"].iloc[0]
    elif "Reale" in group.columns and group["Reale"].notna().any():
        val = group["Reale"].iloc[0]

    colore = "red" if is_visited(val) else "blue"
    popup_html = crea_popup( group["Luogo"].iloc[0], pers, group["testi"].dropna().unique(), id_map, 0)

    # id pulito per HTML e JS
    clean_luogo = re.sub(r"\W+", "", luogo)

    layer = persona_rossa_layer if colore=="red" else persona_blu_layer
    folium.Marker(
        location=[lat, lon],
        popup=folium.Popup(popup_html, max_width=300),
        icon=folium.Icon(color=colore, icon="user", prefix="fa"),
        title=make_id(pers, group["Luogo"].iloc[0])
    ).add_to(layer)

    # nota: l'aggiunta di script che fa riferimento a "markers" √® stata rimossa perch√© nel tuo
    # snippet originale l'array "markers" non √® definito nel contesto; se vuoi conservarla,
    # devi iniettare il codice JS corretto che tiene traccia dei marker creati da Folium.

# ---------- AGGIUNTA MARKER DF1 ----------
# Raggruppa per Lat, Lon e Luogo
from folium import Marker, Popup, Icon, Element
markers_data = []
grouped_df1 = df1.groupby([df1["Lat"].round(5), df1["Lon"].round(5), "Luogo"])

for i, ((lat, lon, luogo), group) in enumerate(grouped_df1):

    val = None
    if "Visitato" in group.columns and group["Visitato"].notna().any():
        val = group["Visitato"].iloc[0]
    elif "Reale" in group.columns and group["Reale"].notna().any():
        val = group["Reale"].iloc[0]

    colore = "red" if is_visited(val) else "blue"

    persone_uniche = group["pers"].dropna().unique().tolist()
    testi_unici = group["testi"].dropna().unique().tolist()

    popup_html = crea_popup_luogo(luogo, persone_uniche, testi_unici, id_map, acc_id=i)

    # ID marker unico
    pers = group["pers"].iloc[0]
    if not isinstance(pers, str) or pers.strip() == "":
        pers = "-"
    id_marker_str = make_id(pers, luogo)

    layer = luogo_rosso_layer if colore == "red" else luogo_blu_layer

    # Creo il marker
    marker = Marker(
        location=[lat, lon],
        popup=Popup(popup_html, max_width=300),
        icon=Icon(color=colore, icon="info-circle", prefix="fa"),
        title=id_marker_str,
        bindPopup= "<a class='link hidden' data-id='{make_id(p, luogo)}' href="#" style="display:none;">{luogo}</a>'"
    ).add_to(layer)
    markers_data.append((marker))
    from folium import Element



map_name = mappa.get_name()   # esempio: "map_1536946495c6b9bbcf4909ae82210f3f"


debug_js = f"""
<script>
document.addEventListener("DOMContentLoaded", function() {{
    var map_var = {map_name};

    if (!window.markers) window.markers = {{}};

    console.log("=== DEBUG: SCRIPT CARICATO ===");

    // Trova il cluster principale (Folium lo chiama marker_cluster_xxx)
    var realCluster = null;
    for (var k in window) {{
        if (k.startsWith("marker_cluster_")) {{
            realCluster = window[k];
            console.log("DEBUG: trovato cluster:", k);
            break;
        }}
    }}

    if (!realCluster) {{
        console.error("ERRORE: nessun MarkerCluster trovato!");
        return;
    }}

    console.log("=== DEBUG: realCluster ASSEGNATO ===", realCluster);

    // ------------------------------
    // FUNZIONE DI SCANSIONE RICORSIVA
    // ------------------------------
    function scanNode(node) {{
        var out = {{}};

        if (!node) return out;

        // Caso: marker singolo
        if (node instanceof L.Marker && !(node instanceof L.MarkerCluster)) {{
            out.type = "marker";
            out.latlng = node.getLatLng();
            out.title = node.options?.title || null;

            // üíæ Registriamo il marker
            if (node.options && node.options.title)
                window.markers[node.options.title] = node;

            return out;
        }}

        // Caso: cluster ‚Üí scendiamo nei figli!
        if (node instanceof L.MarkerCluster) {{
            out.type = "cluster";
            out.childCount = node.getChildCount();
            out.children = [];

            var kids = node.getAllChildMarkers();
            kids.forEach(function(ch) {{
                out.children.push(scanNode(ch));
            }});

            return out;
        }}

        return {{"type": "unknown"}};
    }}

    console.log("=== DEBUG: INIZIO DUMP ===");

    var fullTree = scanNode(realCluster._topClusterLevel);
    console.log("=== ALBERO COMPLETO ===");
    console.log(JSON.stringify(fullTree, null, 2));

    console.log("=== MARKERS TOTALI REGISTRATI ===");
    console.log(Object.keys(window.markers));

    // --------------------------
    // GESTIONE CLICK LINK POPUP
    // --------------------------
    map_var.on('popupopen', function(e) {{
        const popup = e.popup.getElement();
        const links = popup.querySelectorAll('a.link');

        links.forEach(link => {{
            link.onclick = function(ev) {{
                ev.preventDefault();
                const id = link.dataset.id;
                const marker = window.markers[id];

                if (!marker) {{
                    console.warn("DEBUG: marker non trovato:", id);
                    return;
                }}

                console.log("DEBUG: cliccato:", id);

                realCluster.zoomToShowLayer(marker, function() {{
                    console.log("DEBUG: callback zoomToShowLayer -> apro popup");
                    marker.openPopup();
                    map_var.setView(marker.getLatLng());
                }});
            }};
        }});
    }});
}});
</script>
"""



mappa.get_root().html.add_child(Element(debug_js))













# Aggiunge lo script alla mappa








# ---------- AGGIUNTA MARKER LIBRI ----------'''
for _, riga in df_libri.iterrows():
    # Estrazione dati
    coord_rep = str(riga.get("Coordinate_Decimali_rep", "-")).strip()
    coord_luogo = str(riga.get("Coordinate_Decimali_luogo", "-")).strip()

    popup_html = f"""
    <div style="font-family:Arial; font-size:13px; line-height:1.5; color:#333; padding:8px; border-radius:10px;
                background:#fdfdfd; border:1px solid #ccc; box-shadow:0 2px 6px rgba(0,0,0,0.1); max-width:280px;">
        <div style="margin-bottom:6px;"><b style="color:#2b5c99;">üìö Repositorio:</b><br>{riga.get('Repositorio','‚Äî')}</div>
        <div style="margin-bottom:6px;"><b style="color:#2b5c99;">üßæ Segnatura:</b><br>{riga.get('Segnatura','‚Äî')}</div>
        <div style="margin-bottom:6px;"><b style="color:#2b5c99;">üìñ Contenuto:</b><br>{riga.get('Contenuto','‚Äî')}</div>
        <div style="margin-bottom:6px;"><b style="color:#2b5c99;">üìÖ Epoca di copiatura:</b><br>{riga.get('Epoca di copiatura','‚Äî')}</div>
        <div style="margin-bottom:6px;"><b style="color:#2b5c99;">üìç Luogo di copiatura:</b><br>{riga.get('Luogo di copiatura','‚Äî')}</div>
        <div><b style="color:#2b5c99;">üîó Risorsa digitalizzata:</b><br>
            <a href="{riga.get('Risorsa digitalizzata','#')}" target="_blank" style="color:#0078d7;text-decoration:none;">
            {"Apri risorsa" if riga.get('Risorsa digitalizzata') else "‚Äî"}
            </a>
        </div>
    </div>
    """

    # CASO 1: doppio marker (blu + rosso)
    if coord_rep != "-" and coord_luogo != "-":
        try:
            lat_rep, lon_rep = map(float, coord_rep.split(","))
            lat_luogo, lon_luogo = map(float, coord_luogo.split(","))

            # Marker blu ‚Üí Coordinate_Decimali_rep
            folium.Marker(
                location=[lat_rep, lon_rep],
                popup=folium.Popup(popup_html, max_width=300),
                icon=folium.Icon(color="blue", icon="book", prefix="fa")
            ).add_to(libro_blu_layer)

            # Marker rosso ‚Üí Coordinate_Decimali_luogo
            folium.Marker(
                location=[lat_luogo, lon_luogo],
                popup=folium.Popup(popup_html, max_width=300),
                icon=folium.Icon(color="red", icon="book", prefix="fa")
            ).add_to(libro_rosso_layer)

        except ValueError:
            continue

    # CASO 2: solo marker blu
    elif coord_rep != "-" and coord_luogo == "-":
        try:
            lat, lon = map(float, coord_rep.split(","))
            folium.Marker(
                location=[lat, lon],
                popup=folium.Popup(popup_html, max_width=300),
                icon=folium.Icon(color="blue", icon="book", prefix="fa")
            ).add_to(libro_blu_layer)
        except ValueError:
            continue

    # CASO 3: solo marker rosso
    elif coord_rep == "-" and coord_luogo != "-":
        try:
            lat, lon = map(float, coord_luogo.split(","))
            folium.Marker(
                location=[lat, lon],
                popup=folium.Popup(popup_html, max_width=300),
                icon=folium.Icon(color="red", icon="book", prefix="fa")
            ).add_to(libro_rosso_layer)
        except ValueError:
            continue

# ---------- LUOGHI EXTRA ----------
luoghi_extra = [
    ("Mosca", [55.751244, 37.618423]),
    ("Monte Athos", [40.2644928, 24.2152731]),
    ("Monastero di Vatopedi",[40.319087087906524, 24.21205882499249]),
    ("Volokolamsk", [56.0363252, 35.9573132]),
    ("Tver'", [56.85836, 35.90057]),
    ("Sergiev Posad", [56.3242317, 38.1452115]),
    ("Costantinopoli", [41.01193960683002, 28.966850824924762])
]

for nome, coord in luoghi_extra:
    popup_html = f"<b>{nome}</b>"
    folium.Marker(
        location=coord,
        popup=popup_html,
        icon=folium.Icon(color='gray', icon='map-marker', prefix='fa')
    ).add_to(extra_layer)

# ---------- PERCORSO CRONOLOGICO ----------
percorso = [
    (1492, "Venezia", [45.4408, 12.3155]),
    (1492, "Firenze", [43.7696, 11.2558]),
    (1496, "Bologna", [44.4949, 11.3426]),
    (1496, "Ferrara", [44.8354, 11.6198]),
    (1496, "Padova", [45.4064, 11.8768]),
    (1496, "Venezia", [45.4408, 12.3155]),
    (1497, "Milano", [45.4642, 9.1900]),
    (1497, "Vercelli", [45.3230, 8.4231]),
    (1497, "Venezia", [45.4408, 12.3155]),
    (1497, "Padova", [45.4064, 11.8768]),
    (1497, "Ferrara", [44.8354, 11.6198]),
    (1498, "Mirandola", [44.9968, 11.0546]),
    (1502, "Firenze", [43.7696, 11.2558]),
    (1503, "Venezia", [45.4408, 12.3155]),
    (1504, "Venezia", [45.4408, 12.3155]),
    (1506, "Venezia", [45.4408, 12.3155])
]

coords = [coord for _, _, coord in percorso]
popup_js = [f"{i+1}. {anno} ‚Äì {luogo}" for i, (anno, luogo, _) in enumerate(percorso)]
map_name = mappa.get_name()

animation_js = f"""
<script>
window.onload = function() {{
    var map_var = {map_name};
    var latlngs = {coords};
    var popups = {popup_js};

    var greenIcon = L.icon({{
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
        shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }});

    var marker = L.marker(latlngs[0], {{icon: greenIcon}}).addTo(map_var);
    var polyline = L.polyline([latlngs[0]], {{color:'green', weight:3, opacity:0.8}}).addTo(map_var);

    var i = 1;
    var playing = false;
    var timer = null;

    function animate() {{
        if (i < latlngs.length) {{
            marker.setLatLng(latlngs[i]);
            marker.bindPopup(popups[i]).openPopup();
            polyline.addLatLng(latlngs[i]);
            i++;
            if (playing) timer = setTimeout(animate, 1000);
        }} else {{
            playing = false;
            i = 0;
        }}
    }}

    function togglePlay() {{
        if (!playing) {{
            map_var.setView([44.5, 11.0], 7);
            playing = true;
            animate();
        }} else {{
            playing = false;
            clearTimeout(timer);
        }}
    }}

    var playButton = L.control({{position:'topright'}});
    playButton.onAdd = function(map) {{
        var div = L.DomUtil.create('div','leaflet-bar leaflet-control leaflet-control-custom');
        div.style.position = 'relative';
        div.style.padding = '10px';
        div.style.background = '#fff';
        div.style.borderRadius = '5px';
        div.style.boxShadow = '1px 1px 5px rgba(0,0,0,0.3)';
        div.style.textAlign = 'center';

        // --- Contenuto del player ---
        div.innerHTML = `
            <button style="background:white; border:none; padding:8px 15px; font-size:18px; font-weight:bold; cursor:pointer; border-radius:5px;">
                ‚ñ∂Ô∏è Play/Pause
            </button>
            <button id="closePlayerBtn" style="position:absolute; top:5px; right:5px; background:none; border:none; font-size:16px; cursor:pointer;">&times;</button>
            <div style="margin-top:8px; font-size:14px; font-weight:bold; color:#333; background:#f9f9f9; padding:5px 10px; border-radius:5px;">
                Chronology of Maximus the Greek's journey in Italy
            </div>
        `;

        // --- Pulsante Play/Pause ---
        div.querySelector("button").onclick = togglePlay;

        // --- Pulsante esterno per riaprire ---
        var openBtn = document.createElement('button');
        openBtn.innerHTML = '‚ñ∂Ô∏è Apri player';
        openBtn.style.position = 'fixed';
        openBtn.style.top = '45%';
        openBtn.style.right = '10px';
        openBtn.style.transform = 'translateY(-50%)';
        openBtn.style.zIndex = '9999';
        openBtn.style.padding = '10px 18px';
        openBtn.style.background = '#fff';
        openBtn.style.border = '1px solid #ccc';
        openBtn.style.borderRadius = '8px';
        openBtn.style.cursor = 'pointer';
        openBtn.style.boxShadow = '1px 1px 6px rgba(0,0,0,0.3)';
        openBtn.style.display = 'none';
        openBtn.style.fontSize = '15px';
        openBtn.style.fontWeight = 'bold';
        openBtn.style.color = '#333';
        document.body.appendChild(openBtn);

        // --- Evento chiusura player ---
        var closeBtn = div.querySelector('#closePlayerBtn');
        closeBtn.onclick = function(e) {{
            e.stopPropagation();
            div.style.visibility = 'hidden';
            openBtn.style.display = 'block';
        }};

        // --- Evento riapertura player ---
        openBtn.onclick = function() {{
            div.style.visibility = 'visible';
            openBtn.style.display = 'none';
        }};

        return div;
    }};
    playButton.addTo(map_var);
}};
</script>
"""
mappa.get_root().html.add_child(toggle_layercontrol_js)
mappa.get_root().html.add_child(Element(animation_js))

# ---------- SALVATAGGIO ----------
mappa.save("mappa_animata_cluster3.html")
print("‚úÖ Salvato: mappa_animata_cluster.html")
